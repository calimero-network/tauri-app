name: Release

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:
    inputs:
      version:
        description: "Version to release (e.g., 0.0.1)"
        required: true
        type: string

concurrency:
  group: release-${{ github.ref }}
  cancel-in-progress: false

jobs:
  # Extract version for downstream jobs
  prepare:
    name: Prepare Release
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
    steps:
      - name: Get version from tag or input
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            VERSION="${{ inputs.version }}"
          else
            VERSION="${GITHUB_REF_NAME#v}"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Release version: $VERSION"

  # Build for each platform using reusable workflows
  build-macos:
    name: Build macOS
    needs: prepare
    uses: ./.github/workflows/build-macos.yml
    with:
      version: ${{ needs.prepare.outputs.version }}
    secrets:
      APPLE_CERTIFICATE: ${{ secrets.APPLE_CERTIFICATE }}
      APPLE_CERTIFICATE_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
      APPLE_SIGNING_IDENTITY: ${{ secrets.APPLE_SIGNING_IDENTITY }}
      APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
      APPLE_ID: ${{ secrets.APPLE_ID }}
      APPLE_APP_SPECIFIC_PASSWORD: ${{ secrets.APPLE_APP_SPECIFIC_PASSWORD }}
      TAURI_PRIVATE_KEY: ${{ secrets.TAURI_PRIVATE_KEY }}
      TAURI_KEY_PASSWORD: ${{ secrets.TAURI_KEY_PASSWORD }}
      TAURI_PUBLIC_KEY: ${{ secrets.TAURI_PUBLIC_KEY }}

  build-windows:
    name: Build Windows
    needs: prepare
    uses: ./.github/workflows/build-windows.yml
    with:
      version: ${{ needs.prepare.outputs.version }}
    secrets:
      TAURI_PRIVATE_KEY: ${{ secrets.TAURI_PRIVATE_KEY }}
      TAURI_KEY_PASSWORD: ${{ secrets.TAURI_KEY_PASSWORD }}
      TAURI_PUBLIC_KEY: ${{ secrets.TAURI_PUBLIC_KEY }}
      WINDOWS_CERTIFICATE: ${{ secrets.WINDOWS_CERTIFICATE }}
      WINDOWS_CERTIFICATE_PASSWORD: ${{ secrets.WINDOWS_CERTIFICATE_PASSWORD }}

  build-linux:
    name: Build Linux
    needs: prepare
    uses: ./.github/workflows/build-linux.yml
    with:
      version: ${{ needs.prepare.outputs.version }}
    secrets:
      TAURI_PRIVATE_KEY: ${{ secrets.TAURI_PRIVATE_KEY }}
      TAURI_KEY_PASSWORD: ${{ secrets.TAURI_KEY_PASSWORD }}
      TAURI_PUBLIC_KEY: ${{ secrets.TAURI_PUBLIC_KEY }}

  # Publish release with all platform artifacts
  publish:
    name: Publish Release
    needs: [prepare, build-macos, build-windows, build-linux]
    # Continue even if some platforms fail (partial release)
    if: always() && needs.prepare.result == 'success' && (needs.build-macos.result == 'success' || needs.build-windows.result == 'success' || needs.build-linux.result == 'success')
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download macOS artifacts
        if: needs.build-macos.result == 'success'
        uses: actions/download-artifact@v4
        with:
          name: macos-build
          path: release-assets/

      - name: Download Windows artifacts
        if: needs.build-windows.result == 'success'
        uses: actions/download-artifact@v4
        with:
          name: windows-build
          path: release-assets/

      - name: Download Linux artifacts
        if: needs.build-linux.result == 'success'
        uses: actions/download-artifact@v4
        with:
          name: linux-build
          path: release-assets/

      - name: List collected assets
        run: |
          echo "Release assets:"
          find release-assets/ -type f -ls

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Generate latest.json (Tauri updater manifest)
        run: |
          node scripts/release/generate-latest-json.cjs \
            --version "${{ needs.prepare.outputs.version }}" \
            --repo "${{ github.repository }}" \
            --assets release-assets/ \
            --output release-assets/latest.json

      - name: Generate release.json (download site metadata)
        run: |
          node scripts/release/generate-release-json.cjs \
            --version "${{ needs.prepare.outputs.version }}" \
            --repo "${{ github.repository }}" \
            --assets release-assets/ \
            --output release-assets/release.json

      - name: Validate release artifacts
        run: |
          node scripts/release/validate-release.cjs \
            --version "${{ needs.prepare.outputs.version }}" \
            --repo "${{ github.repository }}" \
            --assets release-assets/

      - name: Build release notes
        id: notes
        run: |
          VERSION="${{ needs.prepare.outputs.version }}"

          # Build platform list with actual newlines
          PLATFORMS=""
          if [ "${{ needs.build-macos.result }}" = "success" ]; then
            PLATFORMS="${PLATFORMS}"$'\n'"- **macOS** (Universal): Download the DMG file"
          fi
          if [ "${{ needs.build-windows.result }}" = "success" ]; then
            PLATFORMS="${PLATFORMS}"$'\n'"- **Windows** (64-bit): Download the installer"
          fi
          if [ "${{ needs.build-linux.result }}" = "success" ]; then
            PLATFORMS="${PLATFORMS}"$'\n'"- **Linux** (64-bit): Download AppImage, deb, or rpm"
          fi

          cat > release-notes.md << EOF
          ## Calimero Desktop v${VERSION}

          ### Downloads
          ${PLATFORMS}

          ### Auto-Updates
          Existing installations will automatically update to this version.

          ### Checksums
          See \`release.json\` for file sizes and download URLs.
          EOF

          echo "notes_file=release-notes.md" >> $GITHUB_OUTPUT

      - name: Create GitHub Release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          VERSION="${{ needs.prepare.outputs.version }}"

          echo "Creating release v$VERSION"

          # Create release with notes
          gh release create "v$VERSION" \
            --repo "${{ github.repository }}" \
            --title "v$VERSION" \
            --notes-file release-notes.md \
            --latest

          # Upload all assets from release-assets/
          for file in release-assets/*; do
            if [ -f "$file" ]; then
              filename=$(basename "$file")
              # Skip manifest files (internal use)
              if [[ "$filename" != manifest-*.json ]]; then
                echo "Uploading: $filename"
                gh release upload "v$VERSION" "$file" --repo "${{ github.repository }}"
              fi
            fi
          done

      - name: Summary
        run: |
          VERSION="${{ needs.prepare.outputs.version }}"
          echo "## Release v$VERSION Published" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Artifacts" >> $GITHUB_STEP_SUMMARY
          for file in release-assets/*; do
            if [ -f "$file" ]; then
              filename=$(basename "$file")
              if [[ "$filename" != manifest-*.json ]]; then
                size=$(ls -lh "$file" | awk '{print $5}')
                echo "- \`$filename\` ($size)" >> $GITHUB_STEP_SUMMARY
              fi
            fi
          done
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Links" >> $GITHUB_STEP_SUMMARY
          echo "- [Release Page](https://github.com/${{ github.repository }}/releases/tag/v$VERSION)" >> $GITHUB_STEP_SUMMARY
          echo "- [Download Page](https://${{ github.repository_owner }}.github.io/tauri-app/)" >> $GITHUB_STEP_SUMMARY
